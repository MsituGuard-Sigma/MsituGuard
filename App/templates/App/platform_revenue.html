{% extends 'App/base.html' %}

{% block title %}Platform Revenue Dashboard - MsituGuard{% endblock %}

{% block content %}
<style>
    .revenue-header {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 15px;
    }
    .revenue-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: none;
        transition: transform 0.3s ease;
        margin-bottom: 1rem;
    }
    .revenue-card:hover { transform: translateY(-5px); }
    .revenue-number { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
    .revenue-label { color: #6b7280; font-size: 0.9rem; }
    .profit-positive { color: #22c55e; }
    .profit-negative { color: #ef4444; }
</style>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="revenue-header text-center">
        <div class="container">
            <h1><i class="fas fa-chart-line me-3"></i>MsituGuard Platform Revenue</h1>
            <p class="mb-0 opacity-90">Carbon Credits Marketplace Financial Dashboard</p>
        </div>
    </div>
    
    <!-- Revenue Overview -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="revenue-card">
                <div class="revenue-number text-success">{{ total_user_sales|floatformat:2 }}t</div>
                <div class="revenue-label">Credits Sold by Users</div>
                <small class="text-muted">Platform Marketplace</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="revenue-card">
                <div class="revenue-number text-success">KES {{ corporate_revenue|floatformat:0 }}</div>
                <div class="revenue-label">Corporate Sales Revenue</div>
                <small class="text-muted">@ KES 1000/tonne avg</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="revenue-card">
                <div class="revenue-number text-warning">KES {{ user_payments|floatformat:0 }}</div>
                <div class="revenue-label">User Payments</div>
                <small class="text-muted">@ KES 300/tonne</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="revenue-card">
                <div class="revenue-number profit-positive">KES {{ gross_profit|floatformat:0 }}</div>
                <div class="revenue-label">Gross Profit</div>
                <small class="text-muted">{{ profit_margin }}% margin</small>
            </div>
        </div>
    </div>
    
    <!-- Platform Costs & Net Profit -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="revenue-card">
                <div class="revenue-number text-info">{{ verified_reports|add:verified_trees }}</div>
                <div class="revenue-label">Total Verifications</div>
                <small class="text-muted">Reports + Trees</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="revenue-card">
                <div class="revenue-number text-success">KES {{ org_payments|floatformat:0 }}</div>
                <div class="revenue-label">Organization Payments</div>
                <small class="text-muted">@ KES 50 per verification</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="revenue-card">
                <div class="revenue-number profit-positive">KES {{ net_profit|floatformat:0 }}</div>
                <div class="revenue-label">Net Platform Profit</div>
                <small class="text-muted">After all costs</small>
            </div>
        </div>
    </div>
    
    <!-- Revenue Breakdown -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0 py-4">
                    <h3 class="h4 fw-bold text-success mb-2">Revenue Model Breakdown</h3>
                    <p class="text-muted mb-0">How MsituGuard generates revenue from carbon credits marketplace</p>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 15px; padding: 2rem; border: 2px solid #22c55e;">
                                <h5 class="fw-bold text-success mb-3">Revenue Sources</h5>
                                {% if has_corporate_sales %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Corporate Carbon Credit Sales</span>
                                        <strong class="text-success">KES {{ corporate_revenue|floatformat:0 }}</strong>
                                    </div>
                                    <small class="text-muted">{{ total_user_sales|floatformat:2 }}t sold to corporations at KES 1000/tonne</small>
                                </div>
                                {% else %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Corporate Carbon Credit Sales</span>
                                        <strong class="text-muted">KES 0</strong>
                                    </div>
                                    <small class="text-muted">No user sales to resell to corporations yet</small>
                                </div>
                                {% endif %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Platform Transaction Fees</span>
                                        <strong class="text-success">KES 0</strong>
                                    </div>
                                    <small class="text-muted">Currently waived to encourage adoption</small>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Total Revenue</strong>
                                    <strong class="text-success">KES {{ corporate_revenue|floatformat:0 }}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 15px; padding: 2rem; border: 2px solid #22c55e;">
                                <h5 class="fw-bold text-success mb-3">Platform Costs</h5>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>User Carbon Credit Payments</span>
                                        <strong class="text-success">KES {{ user_payments|floatformat:0 }}</strong>
                                    </div>
                                    <small class="text-muted">{{ total_user_sales|floatformat:2 }}t purchased from users at KES 300/tonne</small>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Organization Verification Payments</span>
                                        <strong class="text-success">KES {{ org_payments|floatformat:0 }}</strong>
                                    </div>
                                    <small class="text-muted">KES 5 per report/tree verification</small>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Total Costs</strong>
                                    <strong class="text-success">KES {{ user_payments|add:org_payments|floatformat:0 }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 20px; padding: 2rem; border: 3px solid #22c55e;">
                            <h4 class="fw-bold text-success mb-2">Net Platform Profit</h4>
                            <div style="font-size: 2.5rem; font-weight: bold; color: #16a34a;">KES {{ net_profit|floatformat:0 }}</div>
                            <p class="text-muted mb-2">Sustainable revenue model supporting environmental protection</p>
                            <div class="alert alert-success mt-3 mb-0">
                                <small><strong>Strong Business Model:</strong><br>
                                • <strong>KES {{ net_profit|floatformat:0 }} profit</strong> from {{ total_user_sales|floatformat:2 }} tonnes carbon credits<br>
                                • <strong>Per tonne margin:</strong> KES 700 profit per tonne sold<br>
                                • <strong>Scalable model:</strong> Each additional tonne = KES 700 profit<br>
                                • <strong>Growth potential:</strong> 10 tonnes/month = KES 7,000 profit</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Transactions -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0 py-4">
                    <h3 class="h4 fw-bold text-success mb-2">Recent Carbon Credit Transactions</h3>
                    <p class="text-muted mb-0">Latest marketplace activity</p>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Amount (tonnes)</th>
                                    <th>Value (KES)</th>
                                    <th>Platform Margin</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in recent_transactions %}
                                <tr>
                                    <td>{{ transaction.created_at|date:"M d, Y" }}</td>
                                    <td>{{ transaction.user.username }}</td>
                                    <td>
                                        {% if transaction.transaction_type == 'sell' %}
                                            <span class="badge bg-success">User Sale</span>
                                        {% elif transaction.transaction_type == 'fund' %}
                                            <span class="badge bg-success">Project Fund</span>
                                        {% else %}
                                            <span class="badge bg-success">{{ transaction.get_transaction_type_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ transaction.amount|floatformat:3 }}</td>
                                    <td>KES {{ transaction.value_kes|floatformat:0 }}</td>
                                    <td>
                                        {% if transaction.transaction_type == 'sell' %}
                                            <span class="text-success">+KES {{ transaction.platform_margin|floatformat:0 }}</span>
                                            <small class="text-muted d-block">Sell to corp @ 1000 - pay user @ 300</small>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <i class="fas fa-chart-line fa-3x text-muted mb-2"></i>
                                        <p class="text-muted">No transactions yet</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Add custom filter for multiplication in template
document.addEventListener('DOMContentLoaded', function() {
    // Any additional JavaScript for the revenue dashboard
    console.log('Platform Revenue Dashboard loaded');
});
</script>

{% endblock %}