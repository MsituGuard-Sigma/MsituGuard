{% extends 'App/base.html' %}
{% block title %}Tree Survival Prediction - MsituGuard{% endblock %}

{% block content %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    min-height: 100vh;
}

.species-card {
    border: 2px solid #e5e7eb;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.species-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.species-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15);
    border-color: #22c55e;
}

.species-card h6 {
    color: #15803d;
    font-weight: 700;
    font-size: 1.3rem;
    margin-bottom: 15px;
}

.species-card p {
    margin-bottom: 10px;
    color: #374151;
    line-height: 1.6;
}

.species-card ul {
    background: #f0fdf4;
    border-radius: 8px;
    padding: 15px 20px;
    margin-top: 10px;
}

.species-card li {
    color: #166534;
    margin-bottom: 5px;
    position: relative;
    padding-left: 20px;
}

.species-card li::before {
    content: '‚úì';
    position: absolute;
    left: 0;
    color: #22c55e;
    font-weight: bold;
}

.location-badge {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    padding: 12px 25px;
    border-radius: 30px;
    font-weight: 700;
    font-size: 1.1rem;
    display: inline-block;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
}

.form-section {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-bottom: 25px;
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
}

.form-section:hover {
    box-shadow: 0 15px 40px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

.form-control {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #fafafa;
}

.form-control:focus {
    border-color: #22c55e;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    background: white;
    transform: translateY(-1px);
}

label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    display: block;
}

.btn-predict {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border: none;
    padding: 15px 35px;
    border-radius: 30px;
    font-weight: 700;
    color: white;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
}

.btn-predict:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border: none;
    border-radius: 25px;
    padding: 10px 25px;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
}

.card {
    border: none;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.alert {
    border: none;
    border-radius: 15px;
    padding: 15px 20px;
    font-weight: 500;
}

@media (max-width: 768px) {
    .form-section {
        padding: 20px;
    }
    
    .species-card {
        padding: 15px;
    }
    
    .btn-predict {
        width: 100%;
    }
}
</style>

<div class="container mt-4">
    <!-- Tree Survival Prediction Header -->
    <div class="text-center mb-5">
        <h2 class="fw-bold mb-3" style="color: #1f2937; font-size: 2.5rem;">Tree Survival Prediction</h2>
        <p class="lead mb-2" style="color: #6b7280; font-size: 1.2rem;">AI-powered recommendations for successful tree planting</p>
        <p class="text-muted" style="font-size: 1rem;">Get personalized species recommendations based on your location's climate and soil conditions</p>
    </div>
    
    <!-- County Input Section -->
    <div class="row justify-content-center" id="countySection">
        <div class="col-md-6">
            <div class="form-section">
                <h5 class="mb-3 text-center"><i class="fas fa-map-marker-alt text-success"></i> Enter Your County / Location</h5>
                
                <!-- GPS Detection -->
                <div id="location-box" class="mb-3">
                    <p id="location-status" class="text-center text-muted">üìç Detecting your location...</p>
                    <div class="text-center">
                        <button id="confirm-county" class="btn btn-outline-success btn-sm" style="display:none;">
                            ‚úî Confirm County
                        </button>
                        <button id="detect-location" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-crosshairs"></i> Detect My Location
                        </button>
                    </div>
                </div>
                
                <div class="form-group mb-3">
                    <input type="text" class="form-control" id="county" placeholder="Type your county (e.g., Meru, Nairobi)">
                </div>
                <div class="text-center">
                    <button id="submitCounty" class="btn btn-success">Get Species Recommendations</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Species Recommendations Section -->
    <div id="recommendationsSection" style="display:none;">
        <div class="text-center mb-4">
            <div class="location-badge" id="locationBadge"></div>
        </div>
        
        <h5 class="text-success mb-4 text-center">üåø Recommended Species & Planting Info:</h5>
        
        <!-- Species Cards Grid -->
        <div class="row" id="speciesGrid"></div>
        
        <!-- Species Selection Form -->
        <div class="row justify-content-center mt-4" id="selectionSection" style="display:none;">
            <div class="col-md-8">
                <div class="form-section">
                    <h5 class="mb-4 text-center"><i class="fas fa-seedling text-success"></i> Make Your Selection</h5>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="species">Choose Species</label>
                            <select class="form-control" id="species">
                                <option value="">-- Select Species --</option>
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="planting_season">Planting Season</label>
                            <select class="form-control" id="planting_season" required>
                                <option value="">-- Select Season --</option>
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="planting_method">Planting Method</label>
                            <select class="form-control" id="planting_method" required>
                                <option value="">-- Select Method --</option>
                                <option value="Seedling">Seedling</option>
                                <option value="Direct Seeding">Direct Seeding</option>
                                <option value="Cutting">Cutting</option>
                            </select>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <button id="predictBtn" class="btn-predict"><i class="fas fa-brain"></i> Predict Survival</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prediction Results Section -->
    <div class="row justify-content-center mt-4" id="resultsCard" style="display:none;">
        <div class="col-md-8">
            <div class="card border-0 shadow">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                    <h5 class="mb-0 text-center"><i class="fas fa-chart-line"></i> Prediction Results</h5>
                </div>
                <div class="card-body" id="resultsDiv"></div>
            </div>
        </div>
    </div>
</div>

<script>
const submitCounty = document.getElementById('submitCounty');
const countyInput = document.getElementById('county');
const recommendationsSection = document.getElementById('recommendationsSection');
const selectionSection = document.getElementById('selectionSection');
const locationBadge = document.getElementById('locationBadge');
const speciesSelect = document.getElementById('species');
const playbookInfo = document.getElementById('playbookInfo');
const plantingSeasonSelect = document.getElementById('planting_season');
const plantingMethodSelect = document.getElementById('planting_method');
const predictBtn = document.getElementById('predictBtn');
const newPredictionBtn = document.getElementById('newPredictionBtn');
const resultsCard = document.getElementById('resultsCard');
const resultsDiv = document.getElementById('resultsDiv');

let speciesPlaybook = {};
let selectedCounty = '';
let detectedCounty = null;
const treeRegistrationUrl = '{{ tree_registration_url }}';

// GPS Detection Logic - Minimal & Guaranteed
document.getElementById('detect-location').addEventListener('click', function() {
    console.log('üîç Button clicked - requesting location');
    
    if (!navigator.geolocation) {
        document.getElementById('location-status').innerHTML = 
            '‚ùå Location is not supported by your browser.';
        return;
    }
    
    document.getElementById('location-status').innerHTML = 
        'üîÑ <strong>Please allow location access when prompted</strong>';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            console.log('‚úÖ GPS Success!', position.coords);
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            document.getElementById('location-status').innerHTML = 
                `üìç <strong>Location found!</strong><br>Detecting county...`;
            
            // Detect county
            fetch('/api/detect-county/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: lat, lon: lon })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if(data.success) {
                    detectedCounty = data.county;
                    document.getElementById('location-status').innerHTML = 
                        `‚úÖ <strong>Found: ${detectedCounty} County</strong><br><small>Is this correct?</small>`;
                    document.getElementById('confirm-county').style.display = 'inline-block';
                    document.getElementById('detect-location').style.display = 'none';
                    
                    // Add "Change County" button for wrong detection
                    const changeBtn = document.createElement('button');
                    changeBtn.id = 'change-county';
                    changeBtn.className = 'btn btn-outline-secondary btn-sm ms-2';
                    changeBtn.innerHTML = '‚úèÔ∏è Change County';
                    document.getElementById('confirm-county').parentNode.appendChild(changeBtn);
                } else {
                    document.getElementById('location-status').innerHTML = 
                        '‚ö†Ô∏è Could not determine county. Please type manually.';
                }
            })
            .catch(function(err) {
                document.getElementById('location-status').innerHTML = 
                    '‚ö†Ô∏è County detection failed. Please type manually.';
                // Hide detect button on county detection failure
                document.getElementById('detect-location').style.display = 'none';
            });
        },
        function(error) {
            console.log('‚ùå GPS Error:', error.code, error.message);
            let msg = '';
            if (error.code === 1) {
                msg = 'üö´ <strong>Location permission denied</strong><br>Please type your county manually.';
            } else if (error.code === 2) {
                msg = 'üì° <strong>Location unavailable</strong><br>Please type your county manually.';
            } else if (error.code === 3) {
                msg = '‚è∞ <strong>Location request timed out</strong><br>Please type your county manually.';
            } else {
                msg = '‚ùå <strong>Location detection failed</strong><br>Please type your county manually.';
            }
            document.getElementById('location-status').innerHTML = msg;
            // Hide detect button on error, allow manual input
            document.getElementById('detect-location').style.display = 'none';
        }
    );
});

// Confirm detected county
document.getElementById('confirm-county').addEventListener('click', () => {
    if(detectedCounty) {
        document.getElementById('county').value = detectedCounty;
        document.getElementById('location-status').innerHTML = 
            `‚úî <strong>Using detected county: ${detectedCounty}</strong>`;
        
        // Hide all GPS-related buttons after confirmation
        document.getElementById('confirm-county').style.display = 'none';
        document.getElementById('detect-location').style.display = 'none';
        const changeBtn = document.getElementById('change-county');
        if(changeBtn) changeBtn.style.display = 'none';
    }
});

// Handle wrong location detection - allow manual input
document.addEventListener('click', function(e) {
    if(e.target && e.target.id === 'change-county') {
        document.getElementById('location-status').innerHTML = 
            '‚úèÔ∏è <strong>Please type your correct county below</strong>';
        
        // Clear the input field and focus on it
        document.getElementById('county').value = '';
        document.getElementById('county').focus();
        
        // Hide GPS buttons, allow manual input
        document.getElementById('confirm-county').style.display = 'none';
        document.getElementById('detect-location').style.display = 'none';
        e.target.style.display = 'none';
    }
});

// STEP 1: Submit county
submitCounty.addEventListener('click', async () => {
    selectedCounty = countyInput.value.trim();
    if(!selectedCounty) return alert('Please enter your county.');

    const resp = await fetch('/api/get-species-recommendations/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({county: selectedCounty})
    });

    const data = await resp.json();
    if(data.success){
        speciesPlaybook = data.playbook;
        
        // Hide county input section
        document.getElementById('countySection').style.display = 'none';
        
        // Show location badge
        locationBadge.textContent = `üìç Your Location: ${selectedCounty}`;
        recommendationsSection.style.display = 'block';

        // Display species info in grid format
        const speciesGrid = document.getElementById('speciesGrid');
        let gridHtml = '';
        Object.keys(speciesPlaybook).forEach(s => {
            const info = speciesPlaybook[s];
            gridHtml += `
                <div class="col-md-6 mb-4">
                    <div class="species-card h-100">
                        <h6>üå≥ ${s}</h6>
                        <p><strong>Best Planting Season:</strong> ${info.best_month.includes(',') ? info.best_month + ' (You can plant in any of these months)' : info.best_month}</p>
                        <p><strong>Recommended Method:</strong> ${info.planting_method || 'Seedling'}</p>
                        <p><strong>Soil Type:</strong> ${info.soil}</p>
                        <p><strong>Water Requirement:</strong> ${info.rainfall_mm}</p>
                        <p><strong>Planting Guide:</strong></p>
                        <ul class="mb-0">${info.planting_guide.map(i=>`<li>${i}</li>`).join('')}</ul>
                    </div>
                </div>
            `;
        });
        speciesGrid.innerHTML = gridHtml;

        // Populate species dropdown
        speciesSelect.innerHTML = '<option value="">-- Select Species --</option>';
        Object.keys(speciesPlaybook).forEach(s => {
            const option = document.createElement('option');
            option.value = s;
            option.textContent = s;
            speciesSelect.appendChild(option);
        });

        selectionSection.style.display = 'block';
        resultsCard.style.display = 'none';
    } else {
        alert('No species found for this county. Please try another county.');
    }
});

// STEP 2: Update Planting Season and Method based on selected species
speciesSelect.addEventListener('change', () => {
    const species = speciesSelect.value;
    if(!species) return;
    const info = speciesPlaybook[species];

    // Update planting seasons
    plantingSeasonSelect.innerHTML = '<option value="">-- Select Season --</option>';
    const seasons = info.best_month.split(',');
    seasons.forEach(season => {
        const option = document.createElement('option');
        option.value = season.trim();
        option.textContent = season.trim();
        plantingSeasonSelect.appendChild(option);
    });
    
    // Update planting methods based on species (keep existing options but highlight recommended)
    const recommendedMethod = info.planting_method || 'Seedling';
    plantingMethodSelect.innerHTML = '<option value="">-- Select Method --</option>';
    
    const methods = ['Seedling', 'Direct Seeding', 'Cutting'];
    methods.forEach(method => {
        const option = document.createElement('option');
        option.value = method;
        option.textContent = method + (method === recommendedMethod ? ' (Recommended)' : '');
        plantingMethodSelect.appendChild(option);
    });
});

// STEP 3: Predict survival
predictBtn.addEventListener('click', async () => {
    const species = speciesSelect.value;
    const plantingSeason = plantingSeasonSelect.value;
    const plantingMethod = plantingMethodSelect.value;
    
    if(!species) return alert('Please select a species.');
    if(!plantingSeason) return alert('Please select a planting season.');
    if(!plantingMethod) return alert('Please select a planting method.');

    const payload = {
        county: selectedCounty,
        tree_species: species,
        planting_season: plantingSeason,
        planting_method: plantingMethod
    };

    const resp = await fetch('/api/predict-tree-survival/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });

    const result = await resp.json();
    console.log('Prediction result:', result); // Debug log
    if(result.success){
        resultsCard.style.display = 'block';
        
        // Build explanation section only if explanation exists
        let explanationHtml = '';
        if(result.explanation) {
            explanationHtml = `
                <div class="mt-4">
                    <h5 class="mb-3"><i class="fas fa-info-circle text-primary me-2"></i>Why This Result?</h5>
                    <div style="background: #f8fafc; border-left: 4px solid #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <p style="color: #1e40af; margin: 0; line-height: 1.6; font-size: 1rem;">${result.explanation}</p>
                    </div>
                </div>
            `;
        }
        
        resultsDiv.innerHTML = `
            <div class="text-center mb-4">
                <div style="font-size: 3.5rem; font-weight: 800; color: #22c55e; margin-bottom: 10px;">${result.survival_percentage || result.survival_probability}%</div>
                <p class="text-muted fs-5">Survival Probability</p>
                <span class="badge bg-${result.confidence_level === 'Very High' ? 'success' : result.confidence_level === 'High' ? 'primary' : result.confidence_level === 'Moderate' ? 'warning' : 'secondary'} fs-6">
                    ${result.confidence_level || 'High'} Confidence
                </span>
            </div>
            <div class="alert alert-${result.risk_level === 'Low' ? 'success' : result.risk_level === 'Medium' ? 'warning' : 'danger'} text-center">
                <i class="fas fa-${result.risk_level === 'Low' ? 'check-circle' : result.risk_level === 'Medium' ? 'exclamation-triangle' : 'times-circle'} me-2"></i>
                <strong>${result.prediction || 'Prediction Available'}</strong> (${result.risk_level} Risk)
            </div>
            
            ${result.reasons && result.reasons.length > 0 ? `
            <div class="mt-4">
                <h5 class="mb-3"><i class="fas fa-lightbulb text-success me-2"></i>Why This Works</h5>
                <div style="background: #f0fdf4; border-radius: 15px; padding: 20px;">
                    ${result.reasons.map(reason => `<div class="d-flex align-items-start mb-2"><i class="fas fa-check-circle text-success me-3 mt-1"></i><span style="color: #166534;">${reason}</span></div>`).join('')}
                </div>
            </div>
            ` : ''}
            
            ${result.risks && result.risks.length > 0 ? `
            <div class="mt-4">
                <h5 class="mb-3"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Potential Risks</h5>
                <div style="background: #fef3c7; border-radius: 15px; padding: 20px;">
                    ${result.risks.map(risk => `<div class="d-flex align-items-start mb-2"><i class="fas fa-exclamation-circle text-warning me-3 mt-1"></i><span style="color: #92400e;">${risk}</span></div>`).join('')}
                </div>
            </div>
            ` : ''}
            
            ${explanationHtml}
            
            <div class="mt-4">
                <h5 class="mb-3"><i class="fas fa-leaf text-success me-2"></i>After-Care Instructions</h5>
                <div style="background: #f0fdf4; border-radius: 15px; padding: 20px;">
                    ${result.after_care.map(i=>`<div class="d-flex align-items-start mb-2"><i class="fas fa-check-circle text-success me-3 mt-1"></i><span style="color: #166534;">${i}</span></div>`).join('')}
                </div>
            </div>
            <div class="text-center mt-4">
                <button id="newPredictionBtn2" class="btn btn-success btn-lg px-4">
                    <i class="fas fa-plus me-2"></i>Make New Prediction
                </button>
            </div>
            
            <div class="text-center mt-3">
                <a href="${treeRegistrationUrl}" class="btn btn-primary btn-lg px-4">
                    <i class="fas fa-tree me-2"></i>Register Your Trees With Us
                </a>
            </div>
        `;
        
        // Hide county input, recommendations and selection sections after prediction
        document.getElementById('countySection').style.display = 'none';
        document.getElementById('recommendationsSection').style.display = 'none';
        document.getElementById('selectionSection').style.display = 'none';
        
        // Add event listener to new prediction button in results
        document.getElementById('newPredictionBtn2').addEventListener('click', () => {
            // Show county and selection sections again
            document.getElementById('countySection').style.display = 'block';
            document.getElementById('selectionSection').style.display = 'block';
            
            // Hide results
            resultsCard.style.display = 'none';
            
            // Reset form
            countyInput.value = '';
            recommendationsSection.style.display = 'none';
            selectionSection.style.display = 'none';
        });
    } else {
        console.error('Prediction failed:', result.error);
        resultsCard.style.display = 'block';
        resultsDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${result.error}</div>`;
    }
});

// Old new prediction button (removed - now in results)
</script>
{% endblock %}
