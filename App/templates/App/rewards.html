{% extends 'App/base.html' %}
{% load static %}

{% block title %}Carbon Credits - MsituGuard{% endblock %}

{% block content %}
{% csrf_token %}
<style>
    /* Enhanced Mobile Responsiveness */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 1rem !important;
        }
        
        .display-4 {
            font-size: 1.8rem !important;
        }
        
        .display-3 {
            font-size: 2rem !important;
        }
        
        .h2, .h3 {
            font-size: 1.3rem !important;
        }
        
        .h4, .h5 {
            font-size: 1.1rem !important;
        }
        
        .card-body {
            padding: 1.25rem !important;
        }
        
        .p-4 {
            padding: 1.25rem !important;
        }
        
        /* Balance card mobile */
        .row.align-items-center .col-md-4 {
            margin-bottom: 1rem !important;
            text-align: center !important;
        }
        
        /* Steps cards mobile */
        .col-md-4 .card {
            margin-bottom: 1rem !important;
        }
        
        /* Activity sections mobile */
        .col-lg-6 {
            margin-bottom: 1.5rem !important;
        }
        
        /* Marketplace cards mobile */
        .col-md-4 .card-body {
            padding: 1rem !important;
        }
        
        /* Table mobile */
        .table-responsive {
            font-size: 0.85rem !important;
        }
        
        .table th,
        .table td {
            padding: 0.5rem 0.25rem !important;
        }
        
        /* Buttons mobile */
        .btn {
            padding: 0.6rem 1rem !important;
            font-size: 0.85rem !important;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem !important;
            font-size: 0.8rem !important;
        }
        
        /* Icons mobile */
        .rounded-circle {
            width: 50px !important;
            height: 50px !important;
        }
        
        .rounded-circle i {
            font-size: 1.2rem !important;
        }
        
        /* Badges mobile */
        .badge {
            font-size: 0.7rem !important;
            padding: 0.3rem 0.6rem !important;
        }
    }
    
    @media (max-width: 480px) {
        .container-fluid {
            padding: 0.75rem !important;
        }
        
        .display-4 {
            font-size: 1.5rem !important;
        }
        
        .display-3 {
            font-size: 1.8rem !important;
        }
        
        .h2, .h3 {
            font-size: 1.1rem !important;
        }
        
        .h4, .h5 {
            font-size: 1rem !important;
        }
        
        .card-body {
            padding: 1rem !important;
        }
        
        .p-4 {
            padding: 1rem !important;
        }
        
        /* Balance card very small */
        .row.align-items-center {
            text-align: center !important;
        }
        
        .row.align-items-center .col-md-4 {
            margin-bottom: 0.75rem !important;
        }
        
        /* Steps very small */
        .col-md-4 {
            margin-bottom: 1rem !important;
        }
        
        .col-md-4 .card-body {
            padding: 0.75rem !important;
        }
        
        /* Activity very small */
        .col-lg-6 {
            margin-bottom: 1rem !important;
        }
        
        /* Table very small */
        .table-responsive {
            font-size: 0.75rem !important;
        }
        
        .table th,
        .table td {
            padding: 0.4rem 0.2rem !important;
        }
        
        /* Buttons very small */
        .btn {
            padding: 0.5rem 0.8rem !important;
            font-size: 0.8rem !important;
            display: block !important;
            width: 100% !important;
            margin-bottom: 0.5rem !important;
        }
        
        .btn-sm {
            padding: 0.35rem 0.6rem !important;
            font-size: 0.75rem !important;
        }
        
        /* Icons very small */
        .rounded-circle {
            width: 45px !important;
            height: 45px !important;
        }
        
        .rounded-circle i {
            font-size: 1rem !important;
        }
        
        /* Marketplace cards very small */
        .d-grid.gap-2 {
            gap: 0.5rem !important;
        }
        
        /* Modal mobile */
        .modal-dialog {
            margin: 0.5rem !important;
        }
        
        .modal-body {
            padding: 1rem !important;
        }
        
        .modal-header h5 {
            font-size: 1rem !important;
        }
        
        /* Activity scroll areas */
        .bg-white.rounded-3 {
            max-height: 200px !important;
        }
        
        /* Balance display mobile */
        .display-3 {
            font-size: 1.5rem !important;
        }
        
        .h2 {
            font-size: 1rem !important;
        }
        
        .h4 {
            font-size: 0.9rem !important;
        }
    }
    
    /* Touch-friendly improvements */
    @media (max-width: 768px) {
        .btn, .card {
            min-height: 44px;
        }
        
        .table td {
            min-height: 40px;
        }
        
        /* Improve tap targets */
        .badge {
            min-height: 24px;
            display: inline-flex;
            align-items: center;
        }
        
        /* Better spacing for touch */
        .d-grid.gap-2 {
            gap: 0.75rem !important;
        }
        
        .mb-3 {
            margin-bottom: 1.5rem !important;
        }
        
        .mb-4 {
            margin-bottom: 2rem !important;
        }
    }
</style>
<div class="container-fluid py-4" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); min-height: 100vh;">
    <div class="container">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-success mb-3">Carbon Credits</h1>
            <p class="lead text-muted">Earn money by planting trees and protecting the environment</p>
        </div>

        <!-- Current Balance -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                    <div class="card-body text-white p-4">
                        <div class="row align-items-center text-center">
                            <div class="col-md-4">
                                <div class="display-3 fw-bold">{{ user.profile.carbon_portfolio_summary.balance|floatformat:2 }}</div>
                                <div class="h5 mb-0">Carbon Credits</div>
                                <small class="opacity-75">(tonnes of CO2)</small>
                            </div>
                            <div class="col-md-4">
                                <div class="h2 fw-bold">KES {{ user.profile.carbon_portfolio_summary.estimated_value|floatformat:0 }}</div>
                                <div class="h6 mb-0">Current Value</div>
                                <small class="opacity-75">Ready to sell</small>
                            </div>
                            <div class="col-md-4">
                                <div class="h4 mb-2">{{ user.profile.carbon_portfolio_summary.co2_impact_kg|floatformat:1 }}kg/year</div>
                                <div class="h6 mb-0">CO2 Absorbed</div>
                                <small class="opacity-75">By your trees</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- How It Works -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-header bg-transparent border-0 py-4">
                        <div class="text-center">
                            <h2 class="h3 fw-bold text-success mb-2">How to Earn Carbon Credits</h2>
                            <p class="text-muted mb-0">Simple steps to start earning money from environmental protection</p>
                        </div>
                    </div>
                    <div class="card-body px-4 pb-4">
                        <div class="row g-4">
                            <!-- Step 1 -->
                            <div class="col-md-4">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                                    <div class="card-body p-4 text-center">
                                        <div class="bg-success rounded-circle p-3 mx-auto mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-seedling text-white fs-4"></i>
                                        </div>
                                        <h5 class="fw-bold text-success mb-2">1. Plant Trees</h5>
                                        <p class="text-muted small mb-3">Use our Tree Prediction tool to find the best trees for your location, then plant them</p>
                                        <a href="{% url 'tree_prediction' %}" class="btn btn-success btn-sm">
                                            Start Planting
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2 -->
                            <div class="col-md-4">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                                    <div class="card-body p-4 text-center">
                                        <div class="bg-success rounded-circle p-3 mx-auto mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-camera text-white fs-4"></i>
                                        </div>
                                        <h5 class="fw-bold text-success mb-2">2. Report & Monitor</h5>
                                        <p class="text-muted small mb-3">Submit environmental reports with photos to help verify your tree growth</p>
                                        <a href="{% url 'alert_create' %}" class="btn btn-success btn-sm">
                                            Submit Report
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3 -->
                            <div class="col-md-4">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                                    <div class="card-body p-4 text-center">
                                        <div class="bg-success rounded-circle p-3 mx-auto mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-coins text-white fs-4"></i>
                                        </div>
                                        <h5 class="fw-bold text-success mb-2">3. Earn Credits</h5>
                                        <p class="text-muted small mb-3">Get verified carbon credits automatically as your trees grow and absorb CO2</p>
                                        <button class="btn btn-outline-success btn-sm" disabled>
                                            Auto-Generated
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Your Activity -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-header bg-transparent border-0 py-4">
                        <div class="text-center">
                            <h2 class="h3 fw-bold text-dark mb-2">Your Environmental Activity</h2>
                            <p class="text-muted mb-0">Track your contributions to environmental protection</p>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="row g-0">
                            <!-- Trees Planted -->
                            <div class="col-lg-6">
                                <div class="p-4 h-100" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-right: 1px solid #e5e7eb;">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="bg-success rounded-circle p-3 me-3">
                                            <i class="fas fa-tree text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="h5 fw-bold text-success mb-1">Trees Planted</h3>
                                            <p class="text-muted small mb-0">Your tree planting history</p>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white rounded-3 p-3" style="max-height: 250px; overflow-y: auto; border: 1px solid #d1fae5;">
                                        {% for transaction in carbon_transactions %}
                                            {% if transaction.transaction_type == 'earn' and 'trees' in transaction.description %}
                                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-light">
                                                <div class="flex-grow-1">
                                                    <div class="fw-semibold small text-dark">{{ transaction.description }}</div>
                                                    <small class="text-muted">{{ transaction.created_at|date:"M d, Y" }}</small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">+{{ transaction.amount|floatformat:3 }}t CO2</span>
                                            </div>
                                            {% endif %}
                                        {% empty %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-seedling text-muted fs-3 mb-2"></i>
                                            <p class="text-muted small mb-2">No trees planted yet</p>
                                            <a href="{% url 'tree_prediction' %}" class="btn btn-success btn-sm">Plant Your First Tree</a>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Environmental Reports -->
                            <div class="col-lg-6">
                                <div class="p-4 h-100" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="bg-success rounded-circle p-3 me-3">
                                            <i class="fas fa-camera text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="h5 fw-bold text-success mb-1">Environmental Reports</h3>
                                            <p class="text-muted small mb-0">Your monitoring contributions</p>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white rounded-3 p-3" style="max-height: 250px; overflow-y: auto; border: 1px solid #d1fae5;">
                                        {% for transaction in carbon_transactions %}
                                            {% if transaction.transaction_type == 'earn' and 'monitoring' in transaction.description %}
                                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-light">
                                                <div class="flex-grow-1">
                                                    <div class="fw-semibold small text-dark">{{ transaction.description }}</div>
                                                    <small class="text-muted">{{ transaction.created_at|date:"M d, Y" }}</small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">Verified</span>
                                            </div>
                                            {% endif %}
                                        {% empty %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-camera text-muted fs-3 mb-2"></i>
                                            <p class="text-muted small mb-2">No reports submitted yet</p>
                                            <a href="{% url 'alert_create' %}" class="btn btn-success btn-sm">Submit First Report</a>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carbon Credits Marketplace -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-header bg-transparent border-0 py-4">
                        <div class="text-center">
                            <h2 class="h3 fw-bold text-success mb-2">Carbon Credits Marketplace</h2>
                            <p class="text-muted mb-0">Sell your carbon credits or use them for environmental projects</p>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <!-- Sell Credits -->
                            <div class="col-md-4">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                                    <div class="card-body p-4 text-center">
                                        <div class="bg-success rounded-circle p-3 mx-auto mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-dollar-sign text-white fs-4"></i>
                                        </div>
                                        <h5 class="fw-bold text-success mb-2">Sell Credits</h5>
                                        <p class="text-muted small mb-3">Convert your carbon credits to cash through verified buyers</p>
                                        <div class="mb-3">
                                            <div class="fw-bold text-success">KES 300/tonne</div>
                                            <small class="text-muted">Current market rate</small>
                                        </div>
                                        {% if user.profile.carbon_credits_balance >= 0.1 %}
                                        <button class="btn btn-success btn-sm" onclick="sellCredits()">
                                            <i class="fas fa-handshake me-1"></i>Sell Now
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-success btn-sm" disabled>
                                            <i class="fas fa-lock me-1"></i>Min 0.1t Required
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Offset Projects -->
                            <div class="col-md-4">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                                    <div class="card-body p-4 text-center">
                                        <div class="bg-success rounded-circle p-3 mx-auto mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-leaf text-white fs-4"></i>
                                        </div>
                                        <h5 class="fw-bold text-success mb-2">Fund Projects</h5>
                                        <p class="text-muted small mb-3">Use credits to fund new environmental protection projects</p>
                                        <div class="mb-3">
                                            <div class="fw-bold text-success">0.5t minimum</div>
                                            <small class="text-muted">Per project funding</small>
                                        </div>
                                        {% if user.profile.carbon_credits_balance >= 0.5 %}
                                        <button class="btn btn-success btn-sm" onclick="fundProject()">
                                            <i class="fas fa-seedling me-1"></i>Fund Project
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-success btn-sm" disabled>
                                            <i class="fas fa-lock me-1"></i>Min 0.5t Required
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Trade Credits -->
                            <div class="col-md-4">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                                    <div class="card-body p-4 text-center">
                                        <div class="bg-success rounded-circle p-3 mx-auto mb-3" style="width: 60px; height: 60px;">
                                            <i class="fas fa-exchange-alt text-white fs-4"></i>
                                        </div>
                                        <h5 class="fw-bold text-success mb-2">Trade Credits</h5>
                                        <p class="text-muted small mb-3">Exchange credits with other environmental guardians</p>
                                        <div class="mb-3">
                                            <div class="fw-bold text-success">P2P Trading</div>
                                            <small class="text-muted">Community marketplace</small>
                                        </div>
                                        <button class="btn btn-success btn-sm" onclick="tradeCredits()">
                                            <i class="fas fa-users me-1"></i>View Trades
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievements & AI Tips -->
        <div class="row mb-5">
            <!-- Achievements -->
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                    <div class="card-body p-4">
                        <h5 class="fw-bold text-success mb-3 text-center">Your Achievements</h5>
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            {% if user.profile.badges_list %}
                                {% for badge in user.profile.badges_list %}
                                <span class="badge bg-success text-white px-3 py-2 rounded-pill" style="font-size: 0.8rem;">{{ badge }}</span>
                                {% endfor %}
                            {% else %}
                            <div class="text-center py-2">
                                <i class="fas fa-medal text-muted fs-3 mb-2"></i>
                                <p class="text-muted small mb-2">No achievements yet</p>
                                <small class="text-muted">Plant trees and submit reports to earn badges</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Tips -->
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                    <div class="card-body p-4 text-center">
                        <h5 class="fw-bold text-success mb-2">Get AI Recommendations</h5>
                        <p class="text-muted small mb-3">Get personalized tips to maximize your carbon credit earnings</p>
                        <button class="btn btn-success" onclick="getAICarbonAdvice()">
                            <i class="fas fa-robot me-2"></i>Get AI Tips
                        </button>
                        <div id="carbonAdvice" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Transaction History -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-header bg-transparent border-0 py-4">
                        <div class="text-center">
                            <h2 class="h3 fw-bold text-dark mb-2">Transaction History</h2>
                            <p class="text-muted mb-0">Your complete carbon credits activity</p>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th class="d-none d-md-table-cell">Value (KES)</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in carbon_transactions %}
                                    <tr>
                                        <td>
                                            <small class="text-muted">{{ transaction.created_at|date:"M d" }}</small>
                                        </td>
                                        <td>
                                            {% if transaction.transaction_type == 'earn' %}
                                                <span class="badge bg-success rounded-pill">Earned</span>
                                            {% elif transaction.transaction_type == 'sell' %}
                                                <span class="badge bg-primary rounded-pill">Sold</span>
                                            {% elif transaction.transaction_type == 'fund' %}
                                                <span class="badge bg-info rounded-pill">Funded</span>
                                            {% else %}
                                                <span class="badge bg-warning rounded-pill">{{ transaction.get_transaction_type_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="fw-semibold small">{{ transaction.description|truncatewords:3 }}</div>
                                            {% if transaction.project_name %}
                                                <small class="text-muted d-none d-md-block">Project: {{ transaction.project_name }}</small>
                                            {% endif %}
                                            {% if transaction.buyer_name %}
                                                <small class="text-muted d-none d-md-block">Buyer: {{ transaction.buyer_name }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if transaction.transaction_type == 'earn' %}
                                                <span class="text-success fw-bold">+{{ transaction.amount|floatformat:2 }}t</span>
                                            {% else %}
                                                <span class="text-danger fw-bold">-{{ transaction.amount|floatformat:2 }}t</span>
                                            {% endif %}
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            {% if transaction.value_kes > 0 %}
                                                <span class="fw-bold">{{ transaction.value_kes|floatformat:0 }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-success rounded-pill">{{ transaction.get_status_display }}</span>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <i class="fas fa-history text-muted fs-3 mb-2"></i>
                                            <p class="text-muted mb-2">No transactions yet</p>
                                            <small class="text-muted">Start planting trees and submitting reports to earn carbon credits</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        {% if carbon_transactions %}
                        <div class="text-center mt-4">
                            <small class="text-muted">Showing recent transactions ‚Ä¢ Total portfolio value: KES {{ user.profile.carbon_portfolio_summary.estimated_value|floatformat:0 }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>

<script>
function getAICarbonAdvice() {
    const button = document.querySelector('button[onclick="getAICarbonAdvice()"]');
    const adviceDiv = document.getElementById('carbonAdvice');
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Getting AI Tips...';
    button.disabled = true;
    
    setTimeout(() => {
        const advice = [
            "Plant Indigenous Mix species for 25% higher CO2 absorption in your region",
            "Add organic mulch around trees to boost growth by 15-20%",
            "October-December is optimal planting season for maximum carbon credits",
            "Group plantings with neighbors can increase survival rates to 85%+"
        ];
        
        const randomAdvice = advice[Math.floor(Math.random() * advice.length)];
        
        adviceDiv.innerHTML = `
            <div class="alert alert-success border-0 p-3 mt-2" style="background: #dcfce7; border-radius: 8px;">
                <small class="text-success fw-medium">
                    <i class="fas fa-lightbulb me-1"></i>AI Recommendation:<br>
                    ${randomAdvice}
                </small>
            </div>
        `;
        adviceDiv.style.display = 'block';
        
        button.innerHTML = '<i class="fas fa-robot me-2"></i>Get More Tips';
        button.disabled = false;
    }, 2000);
}

function sellCredits() {
    const currentBalance = {{ user.profile.carbon_credits_balance|floatformat:3 }};
    const estimatedValue = Math.floor(currentBalance * 300);
    
    if (confirm(`Sell ${currentBalance}t of carbon credits for KES ${estimatedValue}?\n\nThis will transfer your credits to verified buyers and deposit money to your M-Pesa account within 24 hours.`)) {
        // Show processing modal
        showMarketplaceModal('Selling Carbon Credits', `
            <div class="text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <h5>Processing Sale...</h5>
                <p class="text-muted">Connecting to carbon credit buyers</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 75%"></div>
                </div>
            </div>
        `);
        
        // Make actual API call
        fetch('/carbon-transaction/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                type: 'sell',
                amount: currentBalance
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMarketplaceModal('Sale Successful! üéâ', `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle text-success fs-1 mb-3"></i>
                        <h5 class="text-success">Credits Sold Successfully!</h5>
                        <div class="alert alert-success mt-3">
                            <strong>Sale Details:</strong><br>
                            ‚Ä¢ Credits Sold: ${currentBalance}t CO2<br>
                            ‚Ä¢ Amount: KES ${estimatedValue}<br>
                            ‚Ä¢ Buyer: EcoCarbon Kenya Ltd<br>
                            ‚Ä¢ Payment: M-Pesa within 24hrs<br>
                            ‚Ä¢ New Balance: ${data.new_balance.toFixed(3)}t CO2
                        </div>
                        <p class="text-muted">You'll receive an SMS confirmation shortly.</p>
                        <button class="btn btn-success" onclick="location.reload()">Refresh Page</button>
                    </div>
                `);
            } else {
                showMarketplaceModal('Sale Failed', `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-warning fs-1 mb-3"></i>
                        <h5 class="text-warning">Transaction Failed</h5>
                        <p class="text-muted">${data.message}</p>
                    </div>
                `);
            }
        })
        .catch(error => {
            showMarketplaceModal('Error', `
                <div class="text-center py-4">
                    <i class="fas fa-times-circle text-danger fs-1 mb-3"></i>
                    <h5 class="text-danger">Network Error</h5>
                    <p class="text-muted">Please check your connection and try again.</p>
                </div>
            `);
        });
    }
}

function fundProject() {
    const projects = [
        { name: 'Mau Forest Restoration', need: '2.5t CO2', impact: '500 trees planted' },
        { name: 'Lake Victoria Cleanup', need: '1.8t CO2', impact: '10km shoreline cleaned' },
        { name: 'Maasai Mara Conservation', need: '3.2t CO2', impact: '1000 hectares protected' }
    ];
    
    const randomProject = projects[Math.floor(Math.random() * projects.length)];
    const fundingAmount = 0.5;
    
    if (confirm(`Fund the ${randomProject.name} project?\n\nYour contribution: ${fundingAmount}t CO2 credits\nProject Impact: ${randomProject.impact}\n\nThis will use your carbon credits to support environmental conservation.`)) {
        // Make actual API call
        fetch('/carbon-transaction/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                type: 'fund',
                amount: fundingAmount
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMarketplaceModal('Project Funded! üåø', `
                    <div class="text-center py-4">
                        <i class="fas fa-seedling text-success fs-1 mb-3"></i>
                        <h5 class="text-success">Thank You for Your Contribution!</h5>
                        <div class="alert alert-success mt-3">
                            <strong>Project: ${randomProject.name}</strong><br>
                            ‚Ä¢ Your Contribution: ${fundingAmount}t CO2 credits<br>
                            ‚Ä¢ Impact: ${randomProject.impact}<br>
                            ‚Ä¢ Status: Funding confirmed<br>
                            ‚Ä¢ New Balance: ${data.new_balance.toFixed(3)}t CO2
                        </div>
                        <p class="text-muted">You'll receive project updates via email.</p>
                        <button class="btn btn-success" onclick="location.reload()">Refresh Page</button>
                    </div>
                `);
            } else {
                showMarketplaceModal('Funding Failed', `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-warning fs-1 mb-3"></i>
                        <h5 class="text-warning">Transaction Failed</h5>
                        <p class="text-muted">${data.message}</p>
                    </div>
                `);
            }
        })
        .catch(error => {
            showMarketplaceModal('Error', `
                <div class="text-center py-4">
                    <i class="fas fa-times-circle text-danger fs-1 mb-3"></i>
                    <h5 class="text-danger">Network Error</h5>
                    <p class="text-muted">Please check your connection and try again.</p>
                </div>
            `);
        });
    }
}

function tradeCredits() {
    const trades = [
        { user: 'John K.', offer: '0.3t CO2', wants: 'Tree seeds + KES 50', location: 'Nairobi' },
        { user: 'Mary W.', offer: '0.8t CO2', wants: 'KES 350', location: 'Mombasa' },
        { user: 'Peter M.', offer: '1.2t CO2', wants: 'Solar panel + KES 200', location: 'Kisumu' }
    ];
    
    let tradesHtml = '<div class="py-3"><h6 class="fw-bold mb-3">Available Trades</h6>';
    trades.forEach((trade, index) => {
        tradesHtml += `
            <div class="border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${trade.user}</strong> <small class="text-muted">(${trade.location})</small><br>
                        <small>Offers: <span class="text-success">${trade.offer}</span> | Wants: ${trade.wants}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-warning" onclick="acceptTrade(${index})">
                        <i class="fas fa-handshake me-1"></i>Trade
                    </button>
                </div>
            </div>
        `;
    });
    tradesHtml += '</div>';
    
    showMarketplaceModal('Carbon Credits Trading', tradesHtml);
}

function acceptTrade(tradeIndex) {
    const trades = [
        { user: 'John K.', offer: '0.3t CO2', wants: 'Tree seeds + KES 50' },
        { user: 'Mary W.', offer: '0.8t CO2', wants: 'KES 350' },
        { user: 'Peter M.', offer: '1.2t CO2', wants: 'Solar panel + KES 200' }
    ];
    
    const trade = trades[tradeIndex];
    
    if (confirm(`Accept trade with ${trade.user}?\n\nYou give: ${trade.wants}\nYou receive: ${trade.offer}\n\nThis trade will be processed through our secure escrow system.`)) {
        showMarketplaceModal('Trade Initiated! ü§ù', `
            <div class="text-center py-4">
                <i class="fas fa-handshake text-warning fs-1 mb-3"></i>
                <h5 class="text-warning">Trade Request Sent!</h5>
                <div class="alert alert-warning mt-3">
                    <strong>Trade with ${trade.user}</strong><br>
                    ‚Ä¢ You give: ${trade.wants}<br>
                    ‚Ä¢ You receive: ${trade.offer}<br>
                    ‚Ä¢ Status: Pending acceptance
                </div>
                <p class="text-muted">Both parties will be notified when the trade is ready.</p>
            </div>
        `);
    }
}

function showMarketplaceModal(title, content) {
    // Remove existing modal if any
    const existingModal = document.getElementById('marketplaceModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create modal
    const modal = document.createElement('div');
    modal.id = 'marketplaceModal';
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    
    modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">${title}</h5>
                    <button type="button" class="btn-close" onclick="closeMarketplaceModal()"></button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" onclick="closeMarketplaceModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeMarketplaceModal() {
    const modal = document.getElementById('marketplaceModal');
    if (modal) {
        modal.remove();
    }
}
</script>
{% endblock %}