{% extends 'App/base.html' %}

{% block content %}
<!-- Leaflet.js for Interactive Maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    /* Map Styles */
    #environmentalMap {
        height: 400px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .map-legend {
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        font-size: 12px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .dashboard-header {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 15px;
    }
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: none;
        transition: transform 0.3s ease;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-number { font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem; }
    .stat-label { color: #6b7280; font-size: 0.9rem; }
    
    .reports-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .reports-header {
        background: #f8fafc;
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }
    .reports-body { padding: 0; }
    
    .report-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: none;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        overflow: hidden;
    }
    .report-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .report-card .card-header {
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem;
    }
    .report-card .card-body {
        padding: 1rem;
    }
    .report-card .card-footer {
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
        padding: 1rem;
    }
    
    .report-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .status-new { background: #fef2f2; color: #dc2626; }
    .status-verified { background: #f0fdf4; color: #16a34a; }
    .status-resolved { background: #f1f5f9; color: #6b7280; }
    
    .report-type {
        background: #f0fdf4;
        color: #16a34a;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .action-btn {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        border: none;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
        margin: 0 0.25rem;
    }
    .btn-verify { background: #22c55e; color: white; }
    .btn-verify:hover { background: #16a34a; transform: translateY(-1px); }
    .btn-resolve { background: #6b7280; color: white; }
    .btn-resolve:hover { background: #4b5563; transform: translateY(-1px); }
    .btn-details { background: #22c55e; color: white; }
    .btn-details:hover { background: #16a34a; transform: translateY(-1px); }
    
    .input-group-text {
        border: 2px solid #e2e8f0;
        border-right: none !important;
    }
    .form-control {
        border: 2px solid #e2e8f0;
        border-left: none !important;
    }
    .form-control:focus {
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }
    .form-control:focus + .input-group-text,
    .input-group-text:has(+ .form-control:focus) {
        border-color: #22c55e;
    }
    .form-select {
        border: 2px solid #e2e8f0;
    }
    .form-select:focus {
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }
    
    /* Section Styling */
    .section-divider {
        position: relative;
        padding: 2rem 0;
    }
    
    .section-divider::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 3px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border-radius: 2px;
    }
    
    .section-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 2rem;
        box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
    }
    
    .tree-icon {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
    }
    
    .section-title {
        color: #1f2937;
        font-weight: 700;
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .section-subtitle {
        color: #6b7280;
        font-size: 1.1rem;
        margin-bottom: 0;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 1rem !important;
        }
        
        .dashboard-header {
            padding: 1.5rem 0 !important;
            margin-bottom: 1.5rem !important;
        }
        
        .dashboard-header h1 {
            font-size: 1.4rem !important;
        }
        
        .section-title {
            font-size: 1.4rem !important;
        }
        
        .section-subtitle {
            font-size: 0.95rem !important;
        }
        
        .section-icon {
            width: 60px !important;
            height: 60px !important;
            font-size: 1.5rem !important;
        }
        
        .stat-card {
            padding: 1rem !important;
            margin-bottom: 1rem !important;
        }
        
        .stat-number {
            font-size: 1.8rem !important;
        }
        
        .stat-label {
            font-size: 0.85rem !important;
        }
        
        .reports-header {
            padding: 1rem !important;
        }
        
        .reports-header .row {
            flex-direction: column !important;
            gap: 1rem !important;
        }
        
        .reports-header .col-md-6:last-child {
            text-align: left !important;
        }
        
        .reports-header .d-flex {
            justify-content: flex-start !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
        }
        
        .reports-header h4 {
            font-size: 1.1rem !important;
        }
        
        .action-btn {
            padding: 0.5rem 0.8rem !important;
            font-size: 0.8rem !important;
            margin: 0.25rem !important;
            min-height: 36px !important;
        }
        
        .report-card {
            margin-bottom: 1rem !important;
        }
        
        .report-card .card-header,
        .report-card .card-body,
        .report-card .card-footer {
            padding: 1rem !important;
        }
        
        .report-card h6 {
            font-size: 0.95rem !important;
        }
        
        .report-type,
        .report-status {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.6rem !important;
        }
        
        .input-group {
            margin-bottom: 1rem !important;
        }
        
        .form-select {
            margin-bottom: 1rem !important;
            font-size: 0.9rem !important;
        }
        
        .form-control {
            font-size: 0.9rem !important;
        }
        
        .modal-dialog {
            margin: 1rem !important;
        }
        
        .modal-body .row {
            flex-direction: column !important;
        }
        
        .modal-body .col-md-4,
        .modal-body .col-md-8 {
            margin-bottom: 1rem !important;
        }
        
        .modal-header h5 {
            font-size: 1.1rem !important;
        }
        
        .col-md-3,
        .col-md-4,
        .col-md-6,
        .col-lg-4 {
            margin-bottom: 1rem !important;
        }
        
        .table-responsive {
            font-size: 0.85rem !important;
        }
        
        .table th,
        .table td {
            padding: 0.5rem 0.25rem !important;
        }
        
        .badge {
            font-size: 0.7rem !important;
            padding: 0.25rem 0.5rem !important;
        }
    }
    
    @media (max-width: 480px) {
        .container-fluid {
            padding: 0.75rem !important;
        }
        
        .dashboard-header {
            padding: 1rem 0 !important;
            margin-bottom: 1rem !important;
        }
        
        .dashboard-header h1 {
            font-size: 1.2rem !important;
        }
        
        .section-title {
            font-size: 1.2rem !important;
        }
        
        .section-subtitle {
            font-size: 0.85rem !important;
        }
        
        .section-icon {
            width: 50px !important;
            height: 50px !important;
            font-size: 1.2rem !important;
        }
        
        .stat-card {
            padding: 0.75rem !important;
            margin-bottom: 0.75rem !important;
        }
        
        .stat-number {
            font-size: 1.5rem !important;
        }
        
        .stat-label {
            font-size: 0.8rem !important;
        }
        
        .reports-header {
            padding: 0.75rem !important;
        }
        
        .reports-header h4 {
            font-size: 1rem !important;
        }
        
        .action-btn {
            padding: 0.4rem 0.6rem !important;
            font-size: 0.75rem !important;
            display: block !important;
            width: 100% !important;
            margin: 0.25rem 0 !important;
            min-height: 40px !important;
        }
        
        .report-card .card-header,
        .report-card .card-body,
        .report-card .card-footer {
            padding: 0.75rem !important;
        }
        
        .report-card h6 {
            font-size: 0.85rem !important;
        }
        
        .report-type,
        .report-status {
            font-size: 0.7rem !important;
            padding: 0.2rem 0.5rem !important;
        }
        
        .form-select,
        .form-control {
            font-size: 0.85rem !important;
            padding: 0.6rem 0.8rem !important;
        }
        
        .modal-dialog {
            margin: 0.5rem !important;
        }
        
        .modal-body {
            padding: 0.75rem !important;
        }
        
        .modal-header h5 {
            font-size: 0.95rem !important;
        }
        
        .table-responsive {
            font-size: 0.75rem !important;
        }
        
        .table th,
        .table td {
            padding: 0.4rem 0.2rem !important;
        }
        
        .badge {
            font-size: 0.65rem !important;
            padding: 0.2rem 0.4rem !important;
        }
        
        .report-card img {
            max-height: 100px !important;
        }
        
        .form-check-input {
            width: 1.2em !important;
            height: 1.2em !important;
        }
        
        .mb-3 {
            margin-bottom: 1rem !important;
        }
        
        .mb-4 {
            margin-bottom: 1.5rem !important;
        }
        
        .mb-5 {
            margin-bottom: 2rem !important;
        }
    }
    
    /* Touch-friendly improvements */
    @media (max-width: 768px) {
        .btn,
        .action-btn {
            min-height: 44px;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .d-grid.gap-2 {
            gap: 0.75rem !important;
        }
        
        .report-card {
            transition: transform 0.2s ease;
        }
        
        .report-card:active {
            transform: scale(0.98);
        }
        
        .form-control:focus,
        .form-select:focus {
            transform: none;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.25) !important;
        }
    }
</style>

<div class="container-fluid py-2 py-md-4">
    <!-- Header -->
    <div class="dashboard-header text-center">
        <div class="container">
            <h1><i class="fas fa-building me-3"></i>Organization Dashboard</h1>
            <p class="mb-0 opacity-90">Environmental Reports Management System</p>
        </div>
    </div>
    
        
    <!-- Environmental Activity Map -->
    <div class="section-divider mb-5">
        <div class="text-center mb-4">
            <div class="section-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                <i class="fas fa-map-marked-alt"></i>
            </div>
            <h2 class="section-title">Environmental Activity Overview</h2>
            <p class="section-subtitle">Real-time spatial visualization of environmental monitoring across Kenya</p>
        </div>
        
        <div class="row g-4">
            <div class="col-md-9">
                <div id="environmentalMap"></div>
            </div>
            <div class="col-md-3">
                <div class="map-legend">
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Activity Legend</h6>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #22c55e;"></div>
                        <span>Tree Plantings</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc2626;"></div>
                        <span>Environmental Reports</span>
                    </div>

                    <hr class="my-3">
                    <div class="text-center">
                        <small class="text-muted">Click markers for details</small>
                        <br>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="centerMapOnKenya()">
                            <i class="fas fa-crosshairs me-1"></i>Center Map
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Environmental Reports Overview -->
    <div class="section-divider mb-5">
        <div class="text-center mb-4">
            <div class="section-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="section-title">Environmental Reports Overview</h2>
            <p class="section-subtitle">Track and manage community environmental incident reports</p>
        </div>
        
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number text-danger">{{ new_count }}</div>
                    <div class="stat-label">New Reports</div>
                    <small class="text-muted">Require Review</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number text-success">{{ verified_count }}</div>
                    <div class="stat-label">Verified</div>
                    <small class="text-muted">Confirmed Issues</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number text-secondary">{{ resolved_count }}</div>
                    <div class="stat-label">Resolved</div>
                    <small class="text-muted">Completed</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number text-primary">{{ total_count }}</div>
                    <div class="stat-label">Total Reports</div>
                    <small class="text-muted">All Time</small>
                </div>
            </div>
        </div>
    </div>
    

    
    <!-- Environmental Reports Management -->
    <div class="reports-section mt-5">
        <div class="reports-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0"><i class="fas fa-leaf me-2 text-success"></i>Environmental Reports</h4>
                    <small class="text-muted">Manage and track community environmental reports</small>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end gap-2">
                        <button class="action-btn btn-verify" onclick="bulkVerify()">
                            <i class="fas fa-check-double me-1"></i>Bulk Verify
                        </button>
                        <button class="action-btn btn-details" onclick="exportReports()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Search and Filter Bar -->
            <div class="row mt-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Search by location, type, reporter, description, phone, or AI prediction...">
                    </div>
                </div>
                <div class="col-md-4">
                    <select id="statusFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="new">New Reports</option>
                        <option value="verified">Verified Reports</option>
                        <option value="resolved">Resolved Reports</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="reports-body p-3">
            <div class="row g-3">
                {% for report in reports %}
                <div class="col-md-6 col-lg-4" data-status="{{ report.status }}" data-location="{{ report.location_name|lower }}" data-type="{{ report.get_report_type_display|lower }}" data-reporter="{{ report.reporter.username|lower }}" data-description="{{ report.description|lower }}" data-phone="{{ report.phoneNumber|lower }}" data-predicted="{{ report.predicted_category|lower }}">
                    <div class="report-card">
                        <!-- Card Header -->
                        <div class="card-header d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ report.title }}</h6>
                                <div class="d-flex gap-2 mb-2">
                                    <span class="report-type">{{ report.get_report_type_display }}</span>
                                    <span class="report-status status-{{ report.status }}">{{ report.status }}</span>
                                </div>
                            </div>
                            <input type="checkbox" class="form-check-input report-checkbox" value="{{ report.id }}" {% if report.status != 'new' %}disabled{% endif %}>
                        </div>
                        
                        <!-- Card Body -->
                        <div class="card-body">
                            {% if report.image %}
                            <div class="text-center mb-3">
                                <img src="{{ report.image.url }}" class="img-fluid rounded" style="max-height: 120px; cursor: pointer; object-fit: cover;" onclick="viewImage('{{ report.image.url }}', '{{ report.title }}')">
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                {% if report.description %}
                                <p class="text-muted small mb-2">{{ report.description|truncatewords:15 }}</p>
                                {% endif %}
                                <div class="d-flex align-items-center text-muted small mb-2">
                                    <i class="fas fa-map-marker-alt me-2 text-success"></i>
                                    <span>{{ report.location_name }}</span>
                                </div>
                                <div class="d-flex align-items-center text-muted small mb-2">
                                    <i class="fas fa-clock me-2"></i>
                                    <span>{{ report.timestamp|date:"M d, H:i" }}</span>
                                </div>
                                {% if report.phoneNumber %}
                                <div class="d-flex align-items-center text-muted small mb-2">
                                    <i class="fas fa-phone me-2"></i>
                                    <span>{{ report.phoneNumber }}</span>
                                </div>
                                {% endif %}
                                {% if report.predicted_category %}
                                <div class="d-flex align-items-center text-muted small mb-2">
                                    <i class="fas fa-robot me-2 text-info"></i>
                                    <span>AI: {{ report.predicted_category|title }}</span>
                                </div>
                                {% endif %}
                                {% if report.reporter %}
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="fas fa-user me-2"></i>
                                    <span>{{ report.reporter.username }}</span>
                                </div>
                                {% else %}
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="fas fa-user-secret me-2 text-warning"></i>
                                    <span>Anonymous</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Card Footer -->
                        <div class="card-footer">
                            <div class="d-grid gap-2">
                                <button class="action-btn btn-details" onclick="viewLocation('{{ report.id|escapejs }}', '{{ report.title|escapejs }}', '{{ report.location_name|escapejs }}', '{{ report.description|escapejs }}', '{{ report.latitude|default:"null"|escapejs }}', '{{ report.longitude|default:"null"|escapejs }}')">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </button>
                                {% if report.status == 'new' %}
                                <button class="action-btn btn-verify" onclick="updateStatus('{{ report.id }}', 'verified')">
                                    <i class="fas fa-check me-1"></i>Verify Report
                                </button>
                                {% elif report.status == 'verified' %}
                                <button class="action-btn btn-resolve" onclick="updateStatus('{{ report.id }}', 'resolved')">
                                    <i class="fas fa-check-double me-1"></i>Mark Resolved
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-seedling fa-4x text-success opacity-25"></i>
                        </div>
                        <h5 class="text-muted mb-2">No Environmental Reports Found</h5>
                        <p class="text-muted mb-0">Environmental reports from the community will appear here.</p>
                        <small class="text-muted">Use the search and filter options above to find specific reports.</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    
        
    <!-- Tree Registration System Overview -->
    <div class="section-divider mb-5 mt-5">
        <div class="text-center mb-4">
            <div class="section-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <i class="fas fa-camera"></i>
            </div>
            <h2 class="section-title">Tree Planting Initiative Overview</h2>
            <p class="section-subtitle">Monitor progress towards Kenya's 15 billion trees goal</p>
        </div>
        
        <div class="row g-4 mb-4">
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-number text-warning">{{ total_registered_trees }}</div>
                    <div class="stat-label">Total Trees</div>
                    <small class="text-muted">Photo Verified</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-number text-success">{{ org_registered_trees_count }}</div>
                    <div class="stat-label">Org Trees</div>
                    <small class="text-muted">Organization</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-number text-info">{{ individual_registered_trees_count }}</div>
                    <div class="stat-label">Individual Trees</div>
                    <small class="text-muted">Personal</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-number text-info">{{ total_tree_users }}</div>
                    <div class="stat-label">Total Users</div>
                    <small class="text-muted">All Registrants</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-number text-primary">{{ org_tree_users }}</div>
                    <div class="stat-label">Organizations</div>
                    <small class="text-muted">Org Accounts</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-number text-secondary">{{ individual_tree_users }}</div>
                    <div class="stat-label">Individuals</div>
                    <small class="text-muted">Personal Accounts</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-number text-success">{{ gold_users }}</div>
                    <div class="stat-label">Gold Badges</div>
                    <small class="text-muted">500+ Trees</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-number text-danger">{{ diamond_users }}</div>
                    <div class="stat-label">Diamond Badges</div>
                    <small class="text-muted">1000+ Trees</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Tree Registrations -->
    <div class="reports-section mt-5">
        <div class="reports-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0"><i class="fas fa-camera me-2 text-warning"></i>Tree Planting Participants</h4>
                    <small class="text-muted">Community members participating in 15 billion trees initiative</small>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end gap-2">
                        <button class="action-btn btn-verify" onclick="bulkVerifyTrees()">
                            <i class="fas fa-check-double me-1"></i>Bulk Verify
                        </button>
                        <button class="action-btn btn-details" onclick="exportTreeRegistrations()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                        {% if user.is_superuser %}
                        <a href="{% url 'tree_admin_dashboard' %}" class="action-btn btn-details">
                            <i class="fas fa-cog me-1"></i>Manage System
                        </a>
                        {% endif %}
                        <button class="action-btn btn-verify" onclick="contactSelectedUsers()">
                            <i class="fas fa-envelope me-1"></i>Contact Users
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Search and Filter Bar for Tree Registrations -->
            <div class="row mt-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" id="treeRegSearchInput" class="form-control border-start-0" placeholder="Search by username, email, or badge level..." onkeyup="filterTreeRegistrations()">
                    </div>
                </div>
                <div class="col-md-4">
                    <select id="userTypeFilter" class="form-select" onchange="filterTreeRegistrations()">
                        <option value="">All User Types</option>
                        <option value="individual">Individuals</option>
                        <option value="organisation">Organizations</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="reports-body p-3">
            <div class="row g-3">
                {% for tree in registered_trees|slice:":12" %}
                <div class="col-md-6 col-lg-4" data-user-type="{{ tree.user.treeregistration_profile.user_type|lower }}" data-username="{{ tree.user.username|lower }}" data-email="{{ tree.user.email|lower }}" data-badge="{{ tree.user.treeregistration_profile.badge|default:'none'|lower }}">
                    <div class="report-card">
                        <div class="card-header d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Tree #{{ tree.id }}</h6>
                                <div class="d-flex gap-2 mb-2">
                                    <span class="report-type">{{ tree.user.treeregistration_profile.user_type|title }}</span>
                                    <span class="report-status status-verified">Registered</span>
                                </div>
                            </div>
                            <input type="checkbox" class="form-check-input tree-checkbox" value="{{ tree.user.id }}">
                            <small class="text-muted">{{ tree.uploaded_at|date:"M d" }}</small>
                        </div>
                        
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <img src="{{ tree.photo.url }}" class="img-fluid rounded" style="max-height: 120px; cursor: pointer; object-fit: cover;" onclick="viewImage('{{ tree.photo.url }}', 'Tree Registration #{{ tree.id }}')">
                            </div>
                            
                            <div class="text-center mb-3">
                                <div class="d-flex align-items-center justify-content-center text-muted small mb-2">
                                    <i class="fas fa-building me-2 text-primary"></i>
                                    <span class="fw-medium">{{ tree.user.username }}</span>
                                    {% if tree.user.treeregistration_profile.user_type == 'organisation' %}
                                    <span class="badge bg-primary ms-2">Organization</span>
                                    {% else %}
                                    <span class="badge bg-success ms-2">Individual</span>
                                    {% endif %}
                                </div>
                                <div class="d-flex align-items-center justify-content-center text-muted small mb-2">
                                    <i class="fas fa-seedling me-2 text-success"></i>
                                    <span class="fw-medium">{{ tree.user.treeregistration_profile.tree_count }} trees total</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-center text-muted small mb-2">
                                    <i class="fas fa-envelope me-2 text-info"></i>
                                    <span class="fw-medium">{{ tree.user.email }}</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-center text-muted small">
                                    <i class="fas fa-medal me-2 text-warning"></i>
                                    <span class="badge bg-warning">{{ tree.user.treeregistration_profile.badge }} Badge</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-footer">
                            <div class="d-grid gap-2">
                                <button class="action-btn btn-details" onclick="viewTreeRegistrationDetails('{{ tree.id|escapejs }}', '{{ tree.user.username|escapejs }}', '{{ tree.user.email|escapejs }}', '{{ tree.user.treeregistration_profile.user_type|escapejs }}', '{{ tree.user.treeregistration_profile.tree_count|escapejs }}', '{{ tree.user.treeregistration_profile.badge|escapejs }}', '{{ tree.uploaded_at|date:"c" }}')">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </button>
                                {% if tree.user.treeregistration_profile.user_type == 'organisation' %}
                                <button class="action-btn btn-warning" onclick="viewOrganizationProfile('{{ tree.user.id|escapejs }}')">
                                    <i class="fas fa-building me-1"></i>View Organization
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-camera fa-4x text-warning opacity-25"></i>
                        </div>
                        <h5 class="text-muted mb-2">No Tree Registrations Found</h5>
                        <p class="text-muted mb-0">Photo-based tree registrations from users will appear here.</p>
                        <small class="text-muted">Users can register trees at <a href="/tree-registration/" target="_blank">/tree-registration/</a></small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

<!-- Tree Registration Details Modal -->
<div class="modal fade" id="treeRegistrationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="treeRegistrationModalTitle">Tree Registration Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="treeRegistrationDetails">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-4">
                                <h6 class="text-warning mb-3"><i class="fas fa-camera me-2"></i>Registration Details</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <strong class="text-muted">Tree ID:</strong>
                                        <p class="mb-0" id="treeRegId">Tree ID</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-muted">Username:</strong>
                                        <p class="mb-0" id="treeRegUsername">Username</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-muted">Full Name:</strong>
                                        <p class="mb-0" id="treeRegUserName">Full Name</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-muted">Email:</strong>
                                        <p class="mb-0" id="treeRegEmail">Email</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-muted">Account Type:</strong>
                                        <p class="mb-0" id="treeRegUserType">Account Type</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-muted">Total Trees:</strong>
                                        <p class="mb-0" id="treeRegTreeCount">Tree Count</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-muted">Badge Level:</strong>
                                        <p class="mb-0" id="treeRegBadge">Badge</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-muted">Registration Date:</strong>
                                        <p class="mb-0" id="treeRegDate">Date</p>
                                    </div>
                                    <div class="col-12">
                                        <strong class="text-muted">Account Description:</strong>
                                        <p class="mb-0" id="treeRegAccountDesc">Account Description</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="text-warning mb-3"><i class="fas fa-tools me-2"></i>Quick Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-warning" onclick="contactTreeRegistrant()">
                                    <i class="fas fa-envelope me-2"></i>Contact User
                                </button>
                                <button class="btn btn-info" onclick="addTreeNotes()">
                                    <i class="fas fa-sticky-note me-2"></i>Add Notes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Map Modal -->
<div class="modal fade" id="mapModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalTitle">Report Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reportMap" class="modal-map">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-4">
                                <h6 class="text-success mb-3"><i class="fas fa-info-circle me-2"></i>Report Details</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <strong class="text-muted">Location:</strong>
                                        <p class="mb-0" id="locationName">Location Name</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-muted">Report Type:</strong>
                                        <p class="mb-0" id="reportType">Type</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-muted">Reporter:</strong>
                                        <p class="mb-0" id="reporterName">Reporter</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-muted">Date:</strong>
                                        <p class="mb-0" id="reportDate">Date</p>
                                    </div>
                                    <div class="col-12">
                                        <strong class="text-muted">Description:</strong>
                                        <p class="mb-0" id="reportDescription">Description</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border rounded p-3" style="background: #f8f9fa;">
                                <div class="text-center">
                                    <i class="fas fa-map-marked-alt fa-3x text-success mb-2"></i>
                                    <h6 class="text-muted">Location Map</h6>
                                    <p class="small text-muted mb-2">GPS Coordinates: <span id="gpsCoords">Loading...</span></p>
                                    <button class="btn btn-sm btn-outline-success" onclick="openInMaps()">
                                        <i class="fas fa-external-link-alt me-1"></i>Open in Maps
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="text-success mb-3"><i class="fas fa-tools me-2"></i>Quick Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="quickVerify()">
                                    <i class="fas fa-check me-2"></i>Verify Report
                                </button>
                                <button class="btn btn-warning" onclick="contactReporter()">
                                    <i class="fas fa-phone me-2"></i>Contact Reporter
                                </button>
                                <button class="btn btn-info" onclick="assignTeam()">
                                    <i class="fas fa-users me-2"></i>Assign Team
                                </button>
                                <button class="btn btn-secondary" onclick="addNotes()">
                                    <i class="fas fa-sticky-note me-2"></i>Add Notes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tree registration filtering function
function filterTreeRegistrations() {
    const userType = document.getElementById('userTypeFilter').value;
    const search = document.getElementById('treeRegSearchInput').value.toLowerCase();
    const treeCards = document.querySelectorAll('[data-user-type]');
    
    treeCards.forEach(card => {
        const matchesUserType = userType === '' || card.dataset.userType === userType;
        const matchesSearch = search === '' || 
            card.dataset.username.toLowerCase().includes(search) ||
            card.dataset.email.toLowerCase().includes(search) ||
            card.dataset.badge.toLowerCase().includes(search);
        
        if (matchesUserType && matchesSearch) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Enhanced filtering and search for reports
function filterReports() {
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    const reports = document.querySelectorAll('[data-status][data-reporter]');
    
    reports.forEach(report => {
        const matchesStatus = status === '' || report.dataset.status === status;
        const matchesSearch = search === '' || 
            report.dataset.location.includes(search) ||
            report.dataset.type.includes(search) ||
            report.dataset.reporter.includes(search);
        
        if (matchesStatus && matchesSearch) {
            report.style.display = 'block';
        } else {
            report.style.display = 'none';
        }
    });
}

// Enhanced filtering and search for tree plantings
function filterTreePlantings() {
    const status = document.getElementById('treeStatusFilter').value;
    const search = document.getElementById('treeSearchInput').value.toLowerCase();
    const plantings = document.querySelectorAll('[data-status][data-planter]');
    
    plantings.forEach(planting => {
        const matchesStatus = status === '' || planting.dataset.status === status;
        const matchesSearch = search === '' || 
            planting.dataset.location.includes(search) ||
            planting.dataset.type.includes(search) ||
            planting.dataset.planter.includes(search);
        
        if (matchesStatus && matchesSearch) {
            planting.style.display = 'block';
        } else {
            planting.style.display = 'none';
        }
    });
}

document.getElementById('statusFilter').addEventListener('change', filterReports);
document.getElementById('searchInput').addEventListener('input', filterReports);
document.getElementById('treeStatusFilter').addEventListener('change', filterTreePlantings);
document.getElementById('treeSearchInput').addEventListener('input', filterTreePlantings);

// Enhanced view location with details
function viewLocation(reportId, title, location, description, latitude, longitude) {
    // Get report data from the card
    const reportCard = document.querySelector(`.report-checkbox[value="${reportId}"]`).closest('[data-status]');
    const reportType = reportCard.querySelector('.report-type').textContent;
    const date = reportCard.querySelector('.fa-clock').parentElement.textContent.trim();
    const reporter = reportCard.dataset.reporter || 'Unknown';
    
    // Populate modal
    document.getElementById('mapModalTitle').textContent = title;
    document.getElementById('locationName').textContent = location;
    document.getElementById('reportType').textContent = reportType;
    document.getElementById('reporterName').textContent = reporter;
    document.getElementById('reportDate').textContent = date;
    document.getElementById('reportDescription').textContent = description;
    
    // Store coordinates for Google Maps
    if (latitude && longitude) {
        document.getElementById('gpsCoords').textContent = `${latitude}, ${longitude}`;
        window.currentReportLat = latitude;
        window.currentReportLon = longitude;
    } else {
        // Check if location name contains coordinates
        const coordMatch = location.match(/^(-?\d+\.\d+),\s*(-?\d+\.\d+)$/);
        if (coordMatch) {
            document.getElementById('gpsCoords').textContent = location;
            window.currentReportLat = parseFloat(coordMatch[1]);
            window.currentReportLon = parseFloat(coordMatch[2]);
        } else {
            document.getElementById('gpsCoords').textContent = 'GPS coordinates not available';
            window.currentReportLat = null;
            window.currentReportLon = null;
        }
    }
    
    // Store current report ID for quick actions
    window.currentReportId = reportId;
    
    const modal = new bootstrap.Modal(document.getElementById('mapModal'));
    modal.show();
}

// Open location in external maps
function openInMaps() {
    if (window.currentReportLat && window.currentReportLon) {
        const url = `https://www.google.com/maps?q=${window.currentReportLat},${window.currentReportLon}`;
        window.open(url, '_blank');
    } else {
        // Use location name for search if coordinates not available
        const locationName = document.getElementById('locationName').textContent;
        if (locationName) {
            const url = `https://www.google.com/maps/search/${encodeURIComponent(locationName)}`;
            window.open(url, '_blank');
        } else {
            alert('Location information not available');
        }
    }
}

// Bulk verification
function bulkVerify() {
    const checkboxes = document.querySelectorAll('.report-checkbox:checked');
    const reportIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (reportIds.length === 0) {
        alert('Please select reports to verify');
        return;
    }
    
    if (confirm(`Verify ${reportIds.length} reports?`)) {
        // Process each report
        reportIds.forEach(id => updateStatus(id, 'verified'));
    }
}

// Export reports
function exportReports() {
    window.location.href = '/export/reports/';
}

// Quick actions from modal
function quickVerify() {
    if (window.currentReportId) {
        updateStatus(window.currentReportId, 'verified');
        bootstrap.Modal.getInstance(document.getElementById('mapModal')).hide();
    }
}

function contactReporter() {
    alert('Reporter contacted');
}

function assignTeam() {
    alert('Response team assigned');
}

function addNotes() {
    const notes = prompt('Add notes for this report:');
    if (notes) {
        alert('Notes saved: ' + notes);
    }
}

// Tree planting modal functions
function quickVerifyTree() {
    if (window.currentTreeId) {
        updateTreeStatus(window.currentTreeId, 'verified');
        bootstrap.Modal.getInstance(document.getElementById('treeModal')).hide();
    }
}

function contactPlanter() {
    alert('Planter contacted');
}

function scheduleVisit() {
    alert('Site visit scheduled');
}

function addTreeNotes() {
    const notes = prompt('Add notes for this tree planting:');
    if (notes) {
        alert('Tree planting notes saved: ' + notes);
    }
}

// View full image
function viewImage(imageUrl, title) {
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title} - Evidence Photo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${imageUrl}" class="img-fluid" style="max-height: 500px;">
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const imageModal = new bootstrap.Modal(modal.querySelector('.modal'));
    imageModal.show();
    
    modal.querySelector('.modal').addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// Update report status
function updateStatus(reportId, newStatus) {
    if (confirm(`Are you sure you want to mark this report as ${newStatus}?`)) {
        fetch(`/update-report-status/${reportId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating status');
            }
        });
    }
}

// View full image
function viewImage(imageUrl, title) {
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title} - Evidence Photo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${imageUrl}" class="img-fluid rounded" style="max-height: 500px;">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal.querySelector('.modal'));
    bsModal.show();
    modal.addEventListener('hidden.bs.modal', () => document.body.removeChild(modal));
}

function exportTreeData() {
    window.location.href = '/export/tree-data/';
}

function exportTreeRegistrations() {
    window.location.href = '/export/tree-registrations/';
}

function contactSelectedUsers() {
    // Get selected tree registration checkboxes
    const checkboxes = document.querySelectorAll('.tree-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one tree registration to contact.');
        return;
    }
    
    const userIds = Array.from(checkboxes).map(cb => cb.value);
    // Open email client or redirect to messaging interface
    window.location.href = `/contact/users/?user_ids=${userIds.join(',')}`;
}



// Initialize Environmental Activity Map
let environmentalMap;

function viewTreeRegistrationDetails(treeId, userName, userEmail, userType, treeCount, badge, uploadedAt) {
    // Populate tree registration modal
    document.getElementById('treeRegistrationModalTitle').textContent = `Tree Registration #${treeId} Details`;
    document.getElementById('treeRegId').textContent = treeId;
    document.getElementById('treeRegUsername').textContent = userName;
    document.getElementById('treeRegUserName').textContent = userName;
    document.getElementById('treeRegEmail').textContent = userEmail;
    document.getElementById('treeRegUserType').textContent = userType.charAt(0).toUpperCase() + userType.slice(1);
    document.getElementById('treeRegTreeCount').textContent = treeCount;
    document.getElementById('treeRegBadge').textContent = badge;
    
    // Format and set registration date
    const regDate = new Date(uploadedAt);
    const formattedDate = regDate.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    document.getElementById('treeRegDate').textContent = formattedDate;
    
    // Set account description based on user type
    let accountDesc = '';
    if (userType === 'organisation') {
        accountDesc = ' Organization Account - Perfect for companies and groups planning large-scale tree planting projects';
    } else {
        accountDesc = ' Individual Account - Great for personal tree planting goals and environmental impact tracking';
    }
    document.getElementById('treeRegAccountDesc').textContent = accountDesc;
    
    // Store current tree registration ID for quick actions
    window.currentTreeRegId = treeId;
    window.currentTreeRegUserId = userEmail;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('treeRegistrationModal'));
    modal.show();
}

function viewUserRegistration() {
    if (window.currentTreeRegUserId) {
        // Redirect to user's registration Details
        window.location.href = `/tree-registration/admin-users/?user=${window.currentTreeRegUserId}`;
    }
}

function addTreeNotes() {
    if (window.currentTreeRegId) {
        // Add notes for tree registration (placeholder for now)
        const notes = prompt(`Add notes for Tree #${window.currentTreeRegId}:`);
        if (notes) {
            alert(`Notes added for Tree #${window.currentTreeRegId}: ${notes}`);
        }
    }
}

function contactTreeRegistrant() {
    if (window.currentTreeRegUserId) {
        window.location.href = `mailto:${window.currentTreeRegUserId}`;
    }
}

function viewUserTrees() {
    if (window.currentTreeRegUserId) {
        // Redirect to user's tree registration profile
        window.location.href = `/tree-registration/admin-users/?search=${window.currentTreeRegUserId}`;
    }
}

function manageUserAccount() {
    if (window.currentTreeRegUserId) {
        // Redirect to user management
        window.location.href = `/tree-registration/admin-users/?user=${window.currentTreeRegUserId}`;
    }
}

function viewOrganizationProfile(userId) {
    // Redirect to organization profile
    window.location.href = `/tree-registration/admin-users/?user=${userId}`;
}

function initializeMap() {
    try {
        // Check if map container exists
        const mapContainer = document.getElementById('environmentalMap');
        if (!mapContainer) {
            console.error('Map container not found');
            return;
        }
        
        // Initialize map centered on Kenya with bounds restriction
        environmentalMap = L.map('environmentalMap', {
            center: [-1.2921, 36.8219],
            zoom: 6,
            minZoom: 5,
            maxZoom: 12,
            maxBounds: [[-5.5, 33.5], [5.5, 42.0]] // Kenya boundaries
        });
        
        // Add clean map tiles (same as modal)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap | Kenya Environmental Monitoring'
        }).addTo(environmentalMap);
        
        // Force map to refresh after a short delay
        setTimeout(function() {
            environmentalMap.invalidateSize();
        }, 200);
        
        // Add markers for all environmental data
        addEnvironmentalMarkers();
        
        console.log('Map initialized successfully');
    } catch (error) {
        console.error('Error initializing map:', error);
    }
}

function addEnvironmentalMarkers() {
    try {
        if (!environmentalMap) {
            console.error('Map not initialized, cannot add markers');
            return;
        }
        
        let markerCount = 0;
        
        // Environmental Reports data from Django - using JSON format
        const reportsData = '{{ reports_json|default:"[]" }}';
        const reports = reportsData ? JSON.parse(reportsData) : [];
        
        // Add environmental report markers
        reports.forEach(function(report) {
            if (report.latitude && report.longitude) {
                try {
                    const marker = L.marker([report.latitude, report.longitude], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: '<div style="background: #dc2626; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                            iconSize: [16, 16]
                        })
                    }).addTo(environmentalMap);
                    
                    marker.bindPopup(
                        '<div style="min-width: 200px;">' +
                            '<h6><i class="fas fa-exclamation-triangle text-danger me-1"></i>' + report.title + '</h6>' +
                            '<p class="mb-1"><strong>Location:</strong> ' + report.location_name + '</p>' +
                            '<p class="mb-1"><strong>Type:</strong> ' + report.get_report_type_display + '</p>' +
                            '<p class="mb-1"><strong>Status:</strong> <span class="badge bg-' + (report.status === 'verified' ? 'success' : report.status === 'resolved' ? 'secondary' : 'warning') + '">' + report.status + '</span></p>' +
                            '<p class="mb-2"><strong>Date:</strong> ' + new Date(report.timestamp).toLocaleDateString() + '</p>' +
                            '<button class="btn btn-sm btn-primary" onclick="viewLocation(\'' + report.id + '\', \'' + report.title + '\', \'' + report.location_name + '\', \'' + (report.description || '') + '\', ' + report.latitude + ', ' + report.longitude + ')">' +
                                '<i class="fas fa-eye me-1"></i>View Details' +
                            '</button>' +
                        '</div>'
                    );
                    markerCount++;
                } catch (error) {
                    console.error('Error adding report marker:', error);
                }
            }
        });
        
        // Tree Plantings data from Django - using JSON format  
        const plantingsData = '{{ tree_plantings_json|default:"[]" }}';
        const plantings = plantingsData ? JSON.parse(plantingsData) : [];
        
        // Add tree planting markers
        plantings.forEach(function(planting) {
            if (planting.latitude && planting.longitude) {
                try {
                    const marker = L.marker([planting.latitude, planting.longitude], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: '<div style="background: #22c55e; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                            iconSize: [16, 16]
                        })
                    }).addTo(environmentalMap);
                    
                    marker.bindPopup(
                        '<div style="min-width: 200px;">' +
                            '<h6><i class="fas fa-seedling text-success me-1"></i>' + planting.title + '</h6>' +
                            '<p class="mb-1"><strong>Location:</strong> ' + planting.location_name + '</p>' +
                            '<p class="mb-1"><strong>Trees:</strong> ' + planting.number_of_trees + '</p>' +
                            '<p class="mb-1"><strong>Type:</strong> ' + planting.get_tree_type_display + '</p>' +
                            '<p class="mb-1"><strong>Status:</strong> <span class="badge bg-' + (planting.status === 'verified' ? 'success' : planting.status === 'resolved' ? 'secondary' : 'warning') + '">' + planting.status + '</span></p>' +
                            '<p class="mb-2"><strong>Planter:</strong> ' + planting.planter_display_name + '</p>' +
                            '<button class="btn btn-sm btn-success" onclick="viewTreeDetails(\'' + planting.id + '\', \'' + planting.title + '\', \'' + planting.location_name + '\', \'' + (planting.description || '') + '\', \'' + planting.number_of_trees + '\', \'' + planting.planter_display_name + '\', ' + planting.planter + ', ' + planting.latitude + ', ' + planting.longitude + ', \'' + planting.get_tree_type_display + '\')">' +
                                '<i class="fas fa-eye me-1"></i>View Details' +
                            '</button>' +
                        '</div>'
                    );
                    markerCount++;
                } catch (error) {
                    console.error('Error adding tree marker:', error);
                }
            }
        });
        
        console.log('Added ' + markerCount + ' markers to the map');
        
    } catch (error) {
        console.error('Error adding environmental markers:', error);
    }
}

function centerMapOnKenya() {
    if (environmentalMap) {
        environmentalMap.setView([-1.2921, 36.8219], 6);
    }
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for everything to load
    setTimeout(function() {
        if (typeof L !== 'undefined') {
            initializeMap();
        } else {
            console.error('Leaflet library not loaded');
        }
    }, 100);
});
</script>

{% csrf_token %}
{% endblock %}